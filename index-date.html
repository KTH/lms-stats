<html>
<head>
<meta http-equiv="refresh" content="60" >
<script src="d3.js"></script>
<script src="c3.js"></script>
<link rel="stylesheet" type="text/css" href="c3.css">

<style>
#chart .c3-line-interactions {
  stroke-width: 1px;
}

.c3-xgrid-line.studyline line {
    stroke: #aaa;
}

</style>



</head>

<body>



<div id="chart"></div>





<script>


async function drawGraph(){

// fetch data for global statistics data

  const responseKTHA = await fetch('/api/lms-stats/ktha')
  const myJsonKTHA = await responseKTHA.json()


// data[0].by_date.map(o => o.date)

  myJsonKTHA[0].by_date.map(o => o.date)


// retrieve data for each category

  const dates = myJsonKTHA[0].by_date.map(o => o.date)
  const views = myJsonKTHA[0].by_date.map(o => o.views)
  const participations = myJsonKTHA[0].by_date.map(o => o.participations)


// Generate graph

var chart = c3.generate({
    bindto: '#chart',

    data: {
      x: 'x',

      columns: [
          ['x', ...dates],
          ['views', ...views],
          ['participations', ...participations]
        ],

      axes: {
        participations: 'y2'
        },

      types: {
        participations: 'area-spline',
        views: 'spline'
        }
      },

      point: {
        show: false
        },

      grid: {
        y: {
          show: false
        }
      },
      transition: {
    duration: 2000
},

    color: {
        pattern: ['#000000','#b0c92b']
        },

    axis: {
        x: {
            type: 'timeseries',
            tick: {
                format: '%Y-%m-%d',
                rotate: -90,
                values: ['2016-08-29','2016-10-31','2017-01-17','2017-03-20','2017-08-28','2017-10-30', '2018-01-16','2018-03-19','2018-08-27','2018-10-19','2019-01-15','2019-03-18']

            }
          },

      y: {
          label: {
            text: 'Views (Black line)',
            position: 'outer-middle'
          },

        min: 0,
        padding: {
          top: 0,
          bottom: 0
        }
      },

      y2: {
        show: true,
        label: {
          text: 'Participations (Green line + area)',
          position: 'outer-middle'
        },
        min: 0,
          padding: {
            top: 30,
            bottom: 0
          }
        }
      },

/* Regions not used currently
    regions: [
            {start: '2013-01-01', end: '2013-01-03', class: 'apa'},
            {start: '2013-01-05', end: '2013-01-08'},
            {start: '2014-01-05', end: '2015-01-08', class: 'apa'}
        ],

*/
      zoom: {
        enabled: true,
      }

});


// Lines to indicate study periods



chart.xgrids([{value: '2016-08-29', class: 'studyline', text:'P1-16/17'}]);

chart.xgrids.add([{value: '2016-10-31', class: 'studyline', text:'P2-16/17'}]);

chart.xgrids.add([{value: '2017-01-17', class: 'studyline', text:'P3-16/17'}]);

chart.xgrids.add([{value: '2017-03-20', class: 'studyline', text:'P4-16/17'}]);

chart.xgrids.add([{value: '2017-08-28', class: 'studyline', text:'P1-17/18'}]);

chart.xgrids.add([{value: '2017-10-30', class: 'studyline', text:'P2-17/18'}]);

chart.xgrids.add([{value: '2018-01-16', class: 'studyline', text:'P3-17/18'}]);

chart.xgrids.add([{value: '2018-03-19', class: 'studyline', text:'P4-17/18'}]);

chart.xgrids.add([{value: '2018-08-27', tclass: 'studyline', ext:'P1-18/19'}]);

chart.xgrids.add([{value: '2018-10-19', class: 'studyline', text:'P2-18/19'}]);

chart.xgrids.add([{value: '2019-01-15', class: 'studyline', text:'P3-18/19'}]);

chart.xgrids.add([{value: '2019-03-18', class: 'studyline', text:'P4-18/19'}]);


// Set current date

var today = new Date();
var todaypoint = (new Date().setDate(new Date().getDate()-1));
var todaylabel = new Date().toISOString().slice(0,10);

var then = (new Date().setDate(new Date().getDate()-63));
var thenlabel = (new Date().setDate(new Date().getDate()-60));

// Zoom in using current date

setTimeout(function () {
          chart.axis.min({x: then});
}, 4000);

setTimeout(function () {
chart.xgrids.add([{value: todaypoint, class: 'studyline', text: todaylabel}]);
}, 6000);

setTimeout(function () {
chart.xgrids.add([{value: thenlabel, class: 'studyline', text: '60 days ago'}]);
}, 6500);






// Change scale

// setTimeout(function () {
//         chart.axis.min({x: '2018-01-16'});
// }, 200000);

  }

drawGraph()







</script>

</body>

</html>
